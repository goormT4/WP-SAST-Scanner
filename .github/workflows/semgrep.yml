name: Semgrep


on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare config & reports dir
        run: |
          set -euo pipefail

          mkdir -p reports

          # CONFIG_FILES ì´ˆê¸°í™”
          CONFIG_FILES=""

          # í•­ìƒ ë‘ ê°€ì§€ ë¡œì»¬ ë£° ì ìš©
          [ -f ".semgrep/packs-only.yml" ] && CONFIG_FILES+="--config .semgrep/packs-only.yml "
          [ -f ".semgrep/local-rules.yml" ] && CONFIG_FILES+="--config .semgrep/local-rules.yml "

          # fallback: ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ ë˜ëŠ” ê³µì‹ pack
          if [ -z "$CONFIG_FILES" ]; then
            if [ -f ".semgrep/.semgrep.yml" ]; then
              CONFIG_FILES="--config .semgrep/.semgrep.yml "
            elif [ -f ".semgrep.yml" ]; then
              CONFIG_FILES="--config .semgrep.yml "
            else
              CONFIG_FILES="--config p/php --config p/javascript "
            fi
          fi

          # ê³µë°± ì œê±°
          CONFIG_FILES="$(echo -n "$CONFIG_FILES" | sed -e 's/[[:space:]]*$//')"

          echo "CONFIG_FILES=$CONFIG_FILES" >> "$GITHUB_ENV"

          # ë””ë²„ê·¸
          echo "== CONFIG_FILES chosen =="
          echo "$CONFIG_FILES"
          ls -la .semgrep || true

      - name: Normalize .semgrep rule files (remove BOM / ensure UTF-8)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d ".semgrep" ]; then
            for f in .semgrep/*.yml; do
              [ -f "$f" ] || continue
              sed -i '1s/^\xEF\xBB\xBF//' "$f"
            done
          fi

      - name: Run Semgrep scan
        shell: bash
        run: |
          set -euo pipefail
          echo "Running semgrep scan..."

          # âš ï¸ íƒ€ê²Ÿ ê²½ë¡œ ì§€ì •
          # ì˜ˆ: ì „ì²´ ë ˆí¬ ìŠ¤ìº” -> `.`
          TARGET_PATH="src/wp_plugins"

          semgrep scan $CONFIG_FILES \
            --metrics=off \
            --timeout 120 \
            --json -o reports/semgrep.json \
            "$TARGET_PATH" || true

          if [ ! -s reports/semgrep.json ]; then
            echo "WARN: reports/semgrep.json ì´ ë¹„ì–´ìˆê±°ë‚˜ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (íƒ€ê²Ÿ ê²½ë¡œ/ë£° í™•ì¸ í•„ìš”)"
          fi

      - name: Write full Markdown summary (summary + report file)
        shell: bash
        run: |
          set -euo pipefail
          REPORT_FILE="reports/semgrep-report.md"

          # í—¤ë”
          echo "## ğŸ§ª Semgrep Summary" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length // 0' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

            # Severityë³„ ì „ì²´ ì¹´ìš´íŠ¸
            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            done

            echo "" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "### ğŸ“‹ Full Findings" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "| Severity | Check ID | File | Line | Message |" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "|---------|----------|------|------|---------|" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

            jq -r '
              .results[]
              | "| \(.extra.severity) | \(.check_id) | \(.path) | \(.start.line) | \(.extra.message | gsub("\n"; " ")) |"
            ' reports/semgrep.json | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

            echo "" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "### ğŸ“‚ Findings grouped by file" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
            echo "" | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

            jq -r '
              .results
              | group_by(.path)
              | .[]
              | "#### File: \(. [0].path)"
              , (.[] | "| \(.extra.severity) | \(.check_id) | \(.start.line) | \(.extra.message | gsub("\n"; " ")) |")
            ' reports/semgrep.json | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"

          else
            echo "- Semgrep produced no JSON (likely no matching files or scan failed)." | tee -a "$GITHUB_STEP_SUMMARY" "$REPORT_FILE"
          fi

      - name: Upload semgrep.json to external dashboard (debug)
        shell: bash
        env:
          UPLOAD_URL: "http://3.36.21.85:5000/upload"
        run: |
          set -euo pipefail

          if [ ! -s reports/semgrep.json ]; then
            echo "âš ï¸ reports/semgrep.json ì´ ì—†ì–´ ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          TS="$(date '+%Y%m%d_%H%M%S')"
          FNAME="semgrep_${TS}.json"

          cp reports/semgrep.json "$FNAME"
          echo "ğŸš€ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ ì¤‘... ($FNAME)"

          # ë””ë²„ê·¸ìš© ì˜µì…˜:
          #  -v : verbose, ì–´ë–¤ ë‹¨ê³„ì—ì„œ ë©ˆì¶”ëŠ”ì§€ ì¶œë ¥
          #  --connect-timeout : ì—°ê²° ì‹œë„ ì œí•œ
          #  --max-time : ì „ì²´ ìš”ì²­ ì œí•œ
          curl -v -X POST "$UPLOAD_URL" \
            --connect-timeout 10 \
            --max-time 30 \
            -w '\n[HTTP_CODE] %{http_code}\n' \
            -F "file=@${FNAME};filename=${FNAME};type=application/json" || {
              echo "âŒ curl ì‹¤íŒ¨ (exit code: $?)"
              exit 1
            }

          echo "âœ… ì—…ë¡œë“œ ìš”ì²­ ì „ì†¡ ì™„ë£Œ"


      - name: Upload Semgrep reports (GitHub artifact)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/
