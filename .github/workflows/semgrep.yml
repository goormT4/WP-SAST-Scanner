name: Semgrep Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List PHP files (debug)
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:" $(find . -type f -name "*.php" | wc -l)

      - name: Setup Python & install Semgrep
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare config & reports dir
        shell: bash
        run: |
          mkdir -p reports
          if [ -f ".semgrep/.semgrep.yml" ]; then
            echo "CONFIG=.semgrep/.semgrep.yml" >> "$GITHUB_ENV"
          elif [ -f ".semgrep.yml" ]; then
            echo "CONFIG=.semgrep.yml" >> "$GITHUB_ENV"
          else
            echo "CONFIG=auto" >> "$GITHUB_ENV"
          fi
          echo "CONFIG=$CONFIG chosen"
          echo "Listing .semgrep dir (if exists):"
          ls -la .semgrep || true

      - name: Run Semgrep Scan (JSON)
        shell: bash
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export PYTHONUTF8=1
          mkdir -p reports

          if [ "$CONFIG" = "auto" ]; then
            semgrep scan \
              --config p/php \
              --config p/security-audit \
              --config p/secrets \
              --metrics=off \
              --timeout 60 \
              --json -o reports/semgrep.json src/wp_plugins
          else
            semgrep scan \
              --config "$CONFIG" \
              --metrics=off \
              --timeout 60 \
              --json -o reports/semgrep.json src/wp_plugins
          fi

      - name: Run Semgrep Scan (SARIF)
        shell: bash
        run: |
          set -e
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export PYTHONUTF8=1
          mkdir -p reports

          if [ "$CONFIG" = "auto" ]; then
            semgrep scan \
              --config p/php \
              --config p/security-audit \
              --config p/secrets \
              --metrics=off \
              --timeout 60 \
              --sarif -o reports/semgrep.sarif src/wp_plugins
          else
            semgrep scan \
              --config "$CONFIG" \
              --metrics=off \
              --timeout 60 \
              --sarif -o reports/semgrep.sarif src/wp_plugins
          fi

      - name: Upload SARIF (if exists)
        shell: bash
        run: |
          if [ -f reports/semgrep.sarif ]; then
            echo "Uploading SARIF to GitHub code scanning..."
            gh api --method POST -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -F "sarif=@reports/semgrep.sarif" \
              -F "commit_sha=${{ github.sha }}" || true
          else
            echo "No SARIF found â€” skipping upload"
            ls -la reports || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Write Markdown Summary
        shell: bash
        run: |
          echo "## ðŸ§ª Semgrep Summary" >> "$GITHUB_STEP_SUMMARY"

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length // 0' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> "$GITHUB_STEP_SUMMARY"

            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> "$GITHUB_STEP_SUMMARY"
            done

            echo -e "\n### Top findings (up to 10)\n" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              .results[] 
              | {check_id, path: .path, start: .start.line, message: .extra.message, severity: .extra.severity} 
              | "| \(.severity) | \(.check_id) | \(.path):\(.start) | \(.message | gsub("\\n"; " ")) |"
            ' reports/semgrep.json | head -n 10 >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Semgrep produced no JSON (likely no matching files). Check the PHP file listing step." >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*
          if-no-files-found: warn
          retention-days: 14
