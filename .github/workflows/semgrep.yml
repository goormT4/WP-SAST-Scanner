name: Semgrep CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      - name: Normalize .semgrep YAML files
        run: |
          for f in .semgrep/*.yml; do
            [ -f "$f" ] || continue
            sed -i '1s/^\xEF\xBB\xBF//' "$f"
          done

      - name: Run Semgrep scan
        run: |
          mkdir -p reports
          semgrep scan \
            --config .semgrep/packs-only.yml \
            --config .semgrep/local-rules.yml \
            --metrics=off \
            --timeout 60 \
            --json -o reports/semgrep.json src/wp_plugins

      - name: Summarize findings
        run: |
          echo "## ðŸ§ª Semgrep Summary" >> "$GITHUB_STEP_SUMMARY"
          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length // 0' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- No results found. Check PHP files and rules." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload SARIF
        run: |
          if [ -f reports/semgrep.sarif ]; then
            gh api --method POST -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -F "sarif=@reports/semgrep.sarif" \
              -F "commit_sha=${{ github.sha }}" || true
          else
            echo "No SARIF found â€” skipping upload"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
